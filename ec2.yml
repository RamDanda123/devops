AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::LanguageExtensions
Parameters:
  myVPC:
    Type: String
    Default: "vpc-0a7e507ae6849cf80"
    Description: Enter vpc id
  InstanceList:
    Type: CommaDelimitedList
    Default: "instance1,instance2"
  instanceType:
    Type: String
    Default: "t2.micro"
    AllowedValues: ["t2.micro","t2.small","t2.medium"]
Resources:
  Fn::ForEach::Instances:
    - InstanceLogicalId
    - !Ref InstanceList
    - ${InstanceLogicalId}:
        Type: AWS::EC2::Instance
        Properties:
          ImageId: "ami-0005e0cfe09cc9050"
          InstanceType: !Ref instanceType
          KeyName: !Ref MyKeyPair
          SecurityGroupIds: 
            - !Ref InstanceSecurityGroup
          SubnetId: "subnet-09377a43c76e65fdb"
  MyKeyPair:
    Type: 'AWS::EC2::KeyPair'
    Properties:
      KeyName: "MyKeyPair"
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow http to client host
      VpcId: !Ref myVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
  
  MyEC2Instance: 
    Type: AWS::EC2::Instance
    Properties: 
      ImageId: "ami-0005e0cfe09cc9050"
      KeyName: !Ref MyKeyPair
      InstanceType: "t2.micro"
      SecurityGroupIds: 
        - !Ref InstanceSecurityGroup
      SubnetId: "subnet-09377a43c76e65fdb"